@{
    ViewData["Title"] = "Particulars of " + @ViewBag.ctrl;
    ViewBag.ShowSearch = true;
}
@section HeaderBlock {
    <h4 name="company_name"></h4>
}
<div class="row">
    <div class="card">
        <div class="card-header d-flex justify-content-between mb-3">
            <h3 class="card-title mb-0 fs-4" style="margin-top:1px">
                Company Notice
            </h3>
            <button class="btn btn-sm btn-outline-primary" onclick="add()"><i class="fa fa-plus px-2 fs-6"></i>Add</button>
        </div>
        <div class="card-body">
            <table id="tbl" class="display nowrap" style="width:100%">
                <thead>
                    <tr>
                        <th>Sr.No </th>
                        <th>Type </th>
                        <th>Issued on</th>
                        <th>Meeting on</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            loadCompany()
        });

        function loadTbl() {
            $('#tbl').DataTable().destroy()
            var company = localStorage.getItem("comp_id");
            if (company === null || company === undefined || company === "0") {
                return;
            }
            d = $('#tbl').DataTable({
                ajax: {
                    url: `@R.ApiUrl/@ViewBag.ctrl/GetByCompany/${company}`,
                    dataSrc: ""
                },
                // dom: '<lBf>rtip',
                columns: [
                    {
                        "targets": 0,
                        "render": function (data, type, row, meta) {
                            return meta.row + 1;
                        }
                    },
                    { data: 'type' },
                    { data: 'issueDate', render: (a, b, c) => `${FORMAT_DATE(a)}` },
                    { data: 'meetingDate', render: (a, b, c) => `${FORMAT_DATE(a)}` },
                    {
                        data: null,
                        render: function (a, b, c) {
                            var btn1 = `
                                <div class="btn-group">
                                            <button type="button" class="btn btn-light" onclick="edit(${a.id})">Edit</button>
                                            <button type="button" class="btn btn-light dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown" aria-expanded="false">
                                        <span class="visually-hidden">Toggle Dropdown</span>
                                    </button>
                                    <ul class="dropdown-menu">
                                                <button class="dropdown-item" onclick="print(${a.id})"><i class="fa fa-print px-2 fs-6"></i>Print</button>
                                        <button class="dropdown-item " onclick="del(${a.id})" style="color:red;"><i class="fa fa-trash px-2 fs-6"></i>Delete</button>
                                    </ul>
                                </div>`
                            return btn1

                        }, orderable: false
                    },
                    // { render: (a, b, c) => setRowContent(c), className: 'd-none rowData' }
                ],
                order: [],
            }).on('draw.dt', function () {
                $('.dataTables_length').parent().removeClass('d-flex').removeClass('justify-content-between').addClass('d-flex').addClass('justify-content-between')
                $('input[data-toggle="toggle"]:not(\'.initialized\')').bootstrapToggle().addClass('initialized');
            });
        }

        function changeActive(id, currentStatus) {
            $.get(`@R.ApiUrl/@ViewBag.ctrl/${id}/Status/${!currentStatus}`).then(r => {
                toastr[r.status ? 'success' : 'error'](r.message);
                $('#tbl').DataTable().ajax.reload()
            })
        }

        function del(id) {
            if (!confirm('Are you sure you want to delete this?')) return;
            $.get(`@R.ApiUrl/@ViewBag.ctrl/${id}/delete`).then(r => {
                toastr[r.status ? 'success' : 'error'](r.message);
                $('#tbl').DataTable().ajax.reload()
            })
        }

        function edit(id) {
            window.location = `@Url.Action("Company", "Home")/@ViewBag.cid/Notice/Edit/${id}`
        }
        function print(id) {
            window.location = `@Url.Action("CompanyNoticePrint", "Home")/` +id
        }
        function add() {
            var company = localStorage.getItem("comp_id");
            if (company === null || company === undefined || company === "0") {
                alert("Select Company");
                return;
            }
            window.location = `@Url.Action("Company", "Home")/@ViewBag.cid/Notice/Add`
        }

        function autocomplete() {
            $("#headCompSearch").autocomplete({
                source: function (request, response) {
                    // Send AJAX request to the API
                    $.ajax({
                        url: `@R.ApiUrl/Company/S2`,
                        dataType: "json",
                        data: {
                            query: request.term
                        },
                        appendTo: ".search",
                        success: function (data) {
                            response($.map(data, function (item) {
                                return {
                                    label: item.companyName,
                                    value: item.companyName,
                                    id: item.id
                                };
                            }));
                        }
                    });
                },
                select: function (event, ui) {
                    $("#headCompSearch").val("");
                    localStorage.setItem("comp_id", ui.item.id);
                    localStorage.setItem("comp_name", ui.item.label);
                    $('[name="company_name"]').text(ui.item.label);
                    $(".toggle-search:not(.nav-link)").click()
                    loadTbl()
                    window.location = `@Url.Action("Company", "Home")/${ui.item.id}/Notice`

                },
                minLength: 2
            });

        }

        function loadCompany() {
            var company = @ViewBag.cid;
            if (company === null || company === undefined || company === "0") {
                alert("Please select Company")
                window.location = `@Url.Action("Company", "Home")`
                return;
            }
            $._get(`@R.ApiUrl/Company/${company}`).then(x => {
                localStorage.setItem("comp_id", x.id);
                localStorage.setItem("comp_name", x.companyName);
                $('[name="company_name"]').text(x.companyName);

                autocomplete()
                loadTbl()
            })

        }
    </script>
}