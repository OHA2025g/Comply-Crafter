@{
    ViewData["Title"] = "Entity Master";
    //Test
}

<style>
    .btn-primary-custom {
        background-color: #2269f5 !important; /* custom blue */
        border: 1px solid #2269f5 !important;
        color: #fff !important;
        padding: 6px 20px;
        border-radius: 4px;
        font-weight: 500;
    }

        .btn-primary-custom:hover {
            background-color: #1b56c2 !important; /* darker hover */
            border-color: #1b56c2 !important;
        }
</style>
<div class="row m-auto">
    <div class="card">
        <div class="card-header d-flex justify-content-between mb-3">
            <h3 class="card-title mb-0 fs-4" style="margin-top:1px">Name of Entities <small>(Entity Used: <span id="spnCompanyCount">0</span>)</small></h3>
            <button class="btn btn-sm btn-outline-primary" onclick="addCompany()"><i class="fa fa-plus px-2 fs-6"></i>Add</button>
        </div>
        <div class="card-body">
            <table id="tbl" class="display nowrap" style="width:100%">
                <thead>
                    <tr>
                        <th>Sr.No </th>
                        <th>CIN </th>
                        <th>Name</th>
                        <th>Incorporation Date</th>
                        <th>Type of Entity</th>
                        <th>Status</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>
<div class="modal" id="myModal">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">


            <div class="modal-header">
                <h4 class="modal-title">Add Entity</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>


            <div class="modal-body">
                <div class="col-lg-12">
                    <div class="card-body">
                        <table id="tblCompany" class="display nowrap" style="width:100%">
                            <thead>
                                <tr>
                                    <th>Sr No</th>
                                    <th>CIN Number</th>
                                    <th>Name</th>
                                    <th>Type</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .no-underline {
        text-decoration: none;
    }

    td, th {
        text-align: center !important;
    }

        th.text-right, th.text-start {
            text-align: center !important;
        }

</style>


@section Scripts {
    <script>
        $(document).ready(function () {
            CompanyUsed();
                    loadTbl();
                    mcadown();
        });

            function loadTbl() {
                if ($.fn.DataTable.isDataTable('#tbl')) {
                    $('#tbl').DataTable().destroy();
                }

                let table = $('#tbl').DataTable({
                    ajax: {
                       url: `@R.ApiUrl/Company/CompanyList`,
                        dataSrc: ""
                    },
                    columns: [
                        {
                            data: null,
                            render: (data, type, row, meta) => meta.row + 1
                        },
                        { data: 'cin' },
                        {
                            data: 'companyName',
                            render: function (data, type, row) {
                                if(!row.isDeleted)
                                    return `<a href="#" onclick="view(${row.id}); return false;" style="text-decoration: none;">${data}</a>`;
                                else
                                    return `${data}`;
                            },
                            className: 'text-start'
                        },
                        { data: 'incorporationDate', render: (data) => FORMAT_DATE(data) },
                        { data: 'companyType' },
                        {
                            data: 'isActive',
                            render: function (a, b, c) {
                                if(!c.isDeleted)
                                    return `<input type="checkbox" data-toggle="toggle" data-onlabel="Active" data-size="sm" data-id="${c.id}" data-offlabel="Inactive" ${a ? 'checked' : ''} onchange="changeActive(${c.id}, ${a})" data-onstyle="success" data-offstyle="danger">`
                                else
                                    return ``;
                            }
                        },
                        {
                        data: null,
                        render: function (data, type, row) {
                            var btn1 = ``;
                                if(!row.isDeleted)
                                    btn1 =`<div class="d-flex justify-content-center">
                                        <a onclick="view(${row.id})" class="mx-2" style="color: blue; cursor: pointer;" title="View Entity">
                                            <i class="fa fa-eye"></i>
                                        </a>
                                        <a onclick="edit(${row.id})" class="mx-2" style="color: green; cursor: pointer;" title="Edit Entity">
                                            <i class="fa fa-pencil-alt"></i>
                                        </a>
                                        <a onclick="del(${row.id})" class="mx-2" style="color: red; cursor: pointer;" title="Delete Entity">
                                            <i class="fa fa-trash-alt"></i>
                                        </a>
                                    </div>`
                            return btn1

                        }, orderable: false
                    }
                    ],
                    "fnRowCallback": function (nRow, aData, iDisplayIndex) {
                        if(aData.isDeleted)
                            $(nRow).addClass('text-decoration-line-through');
                    },
                    order: [],
                    "drawCallback": function (settings) {
                        $('.dataTables_length').parent().removeClass('d-flex').removeClass('justify-content-between').addClass('d-flex').addClass('justify-content-between');
                        $('input[data-toggle="toggle"]:not(.initialized)').bootstrapToggle().addClass('initialized');
                    }
                });
            }

            function changeActive(id, currentStatus) {
                $.get(`@R.ApiUrl/Company/${id}/Status/${!currentStatus}`).then(r => {
                    toastr[r.status ? 'success' : 'error'](r.message);
                    $('#tbl').DataTable().ajax.reload(null, false);
                })
            }

            function del(id) {
                Swal.fire({
                    icon: 'info',
                    title: 'Attention!',
                    text: 'Are you sure you want to delete this entity?',
                    showCancelButton: true,
                    confirmButtonText: 'Yes, Delete',
                    cancelButtonText: 'No, Cancel',
                }).then((result) => {
                    if (result.isConfirmed) {
                        $.ajax({
                        url: `@R.ApiUrl/Company/Delete?id=${id}`,
                        type: 'DELETE',
                        success: function (r) {
                            toastr[r.status ? 'success' : 'error'](r.message);
                            $('#tbl').DataTable().ajax.reload();
                        },
                        error: function (xhr, status, error) {
                        const statusCode = xhr.status;
                        console.log('Status Code:', statusCode);

                        switch (statusCode) {
                            case 400:
                                toastr.error('Bad Request.');
                                break;
                            case 401:
                                    toastr.error('You are not authorized to delete this item.');
                                break;
                            case 403:
                                toastr.error('Forbidden. You don’t have permission.');
                                break;
                            case 404:
                                toastr.error('Not Found. The resource does not exist.');
                                break;
                            case 500:
                                toastr.error('Internal Server Error.');
                                break;
                            default:
                                // Try to extract a custom message from response
                                let errorMessage = 'An unexpected error occurred.';
                                if (xhr.responseJSON && xhr.responseJSON.message) {
                                    errorMessage = xhr.responseJSON.message;
                                } else if (xhr.responseText) {
                                    try {
                                        const response = JSON.parse(xhr.responseText);
                                        errorMessage = response.message || xhr.responseText;
                                    } catch {
                                        errorMessage = xhr.responseText;
                                    }
                                }
                                toastr.error(errorMessage);
                                break;
                            }
                        }
                    });

                        }
                        else if (result.isDismissed) {
                            toastr.info('Delete cancelled.');
                        }
                });
            }

            function notice(id) {
                window.location = `@Url.Action("Notice", "Company", new { id = "" })/${id}`;
            }

                   function view(id) {
            window.location = '@Url.Action("Company", "Home")' + '/' + id;
        }

        function edit(id) {
            window.location = '@Url.Action("Company", "Home")' + '/Edit/' + id;
        }

            const cinPattern = /^([LUu]{1})([0-9]{5})([A-Za-z]{2})([0-9]{4})([A-Za-z]{3})([0-9]{6})$/;
            const namePattern = /^[A-Za-z\s]+$/;

            function addCompany() {
                swal.fire({
                    icon: 'info',
                    title: 'Add New Entity',
                    text: 'Please enter Corporate Identification Number (CIN) or Corporate Name to get started',
                    input: 'text',
                    inputPlaceholder: 'CIN or Name',
                    confirmButtonText: 'Continue',
                    customClass: {
                        confirmButton: 'btn btn-outline-primary'
                    },
                    preConfirm: function (txt) {
                        if (txt === '') {
                            swal.showValidationMessage('Please enter CIN or Name');
                            return false;
                        }
                        const isCIN = cinPattern.test(txt);

                        const isValidName = namePattern.test(txt);

                        if (isCIN) {
                            return txt; // Valid CIN, return the CIN
                        } else if (isValidName) {
                            return txt; // Valid Name, return the Name
                        } else {
                            swal.showValidationMessage('Please enter a valid CIN or Name');
                            return false;
                        }
                    }
                }).then(r => {
                    if (r.value) {
                        swal.fire('Fetching details...');
                        swal.showLoading();
                        const isCIN = cinPattern.test(r.value);
                        const isValidName = namePattern.test(r.value);
                        if (isCIN) {
                            createCompany(r.value,r.value);

                        } else if (isValidName) {
                            nameToCin(r.value);
                        }


                    }
                })
            }


            function createCompany(cin, cname) {
  Swal.fire({
    icon: 'info',
    title: 'Attention!',
    html: 'Are you sure you want to add <strong>' + cname + '</strong>? Once added, this will count toward your entity limit.',
    showCancelButton: true,
    confirmButtonText: 'Yes, Add it',
    cancelButtonText: 'No, Cancel',
    confirmButtonColor: '#28a745',
    cancelButtonColor: '#d33'
  }).then((result) => {
    if (!result.isConfirmed) {
      toastr.info('Operation cancelled.');
      return;
    }

    debugger;
    Swal.fire({ title: 'Processing...' });
    Swal.showLoading();

    $._get(`@R.ApiUrl/Company/Create/` + cin).then(x => {
      if (x.status) {
        Swal.fire({
          icon: 'success',
          title: 'Success!',
          text: 'Entity Imported Successfully',
          confirmButtonText: 'OK',
          customClass: { confirmButton: 'btn btn-primary-custom' },
          buttonsStyling: false
        }).then(() => {
          window.location = `@Url.Action("Company", "Home")/${x.responseObject}`;
        });
      } else {
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: x.message
        }).then((r) => {
          if (r.isConfirmed && `@AppUtilities.AppUserRole` === 'CompanyAdmin') {
            window.location.href = '@Url.Action("Subscription", "Home")';
          }
        });
      }
    });
  });
}




            function nameToCin(name) {
                $._get(`@R.ApiUrl/Company/NameToCin/` + encodeURIComponent(name)).then(x => {
                    if (x.status) {
                        var companylist = JSON.parse(x.responseObject)
                        if (companylist.results.data) {
                            loadCompanyTbl(companylist.results.data.result)
                        } else {
                            swal.fire({
                                icon: 'error',
                                title: 'Error',
                                text: companylist.message
                            })
                        }
                    } else {
                        swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: x.message
                        })
                    }
                })
            }

            function loadCompanyTbl(ls) {
                swal.close()
                $('#tblCompany').DataTable().destroy()
                d = $('#tblCompany').DataTable({
                    data: ls,
                    columns: [
                        {
                            "targets": 0,
                            "render": function (data, type, row, meta) {
                                return meta.row + 1;
                            }
                        },
                        { data: 'cnNmbr' },
                        { data: 'cmpnyNm' },
                        { data: 'acntType' },
                        {
                            data: null,
                            render: function (a, b, c) {
                                return `
                                        <button class="btn btn-primary" onclick="createCompany('${c.cnNmbr}', '${c.cmpnyNm}')"><i class="fa fa-plus px-2 fs-6"></i>Add</button>
                                    `
                            }, orderable: false
                        },
                    ],
                    order: [],
                }).on('draw.dt', function () {
                    $('.dataTables_length').parent().removeClass('d-flex').removeClass('justify-content-between').addClass('d-flex').addClass('justify-content-between')
                });
                $('#myModal').modal('show');
            }

            async function addCompanyDirector(json) {
                const data = JSON.parse(json);
                const directorPromises = data.data.details.directors.map(async (director) => {
                    await $._post(`@R.ApiUrl/Director/CreateBlank`, { firstName: x.director_name, din: x.din_number });
                });
                await Promise.all(directorPromises);
                window.location = `@Url.Action("Company", "Home")/Add`;
            }
            
            function mcadown() {
                $._get(`@R.ApiUrl/Company/IsMCAReachable`).then(x => {
                    if (!x) {
                        Swal.fire({
                            icon: 'info',
                            title: 'Attention!',
                            text: 'MCA services are currently unavailable. Please try again later.',
                            confirmButtonText: 'OK',
                            confirmButtonColor: '#2269f5' 
                        });
                    }
                })
            }

            function CompanyUsed()
            {
                $.ajax({
                    url: `@R.ApiUrl/Company/CompanyUsedCount`,
                    type: 'GET',
                    headers: {
                        'Authorization': 'Bearer ' + $.cookie("ComplyCrafterSessionId")
                    },
                    success: function (resp) {
                        $('#spnCompanyCount').text(resp);
                    }
                });
            }
    </script>
}