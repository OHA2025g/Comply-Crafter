@{
    ViewData["Title"] = "Particulars of " + @ViewBag.ctrl;
    ViewBag.ShowSearch = true;
}
@section HeaderBlock {
    <h4 name="company_name"></h4>
}
<script>
    $(document).ready(function () {
        const $yearDropdown = $("#yearDropdown");
        const currentYear = new Date().getFullYear();

        for (let i = 0; i < 8; i++) {
            let year = currentYear - i;
            $yearDropdown.append(`<option value="${year}">${year}</option>`);
        }
    });
</script>
<div class="row m-auto">
    <div class="card">
        <div class="card-header d-flex justify-content-between mb-3 align-items-center">
            <h3 class="card-title mb-0 fs-4" style="margin-top:1px">
                <span id="title"></span>
            </h3>

    @*         <select id="yearDropdown" class="form-select form-select-sm w-auto"></select>
            <button class="btn btn-sm btn-outline-primary" onclick="add()"><i class="fa fa-plus px-2 fs-6"></i>Add</button> *@


            <div class="d-flex align-items-center">
                <label for="financialYear" class="form-label mb-0 me-2 fw-bold">Financial Year:</label>

                <select id="financialYear" class="form-select form-select-sm me-2" style="width:180px">
                    <option value="none">Select FY</option>
                </select>

                <button class="btn btn-sm btn-outline-primary" onclick="add()">
                    <i class="fa fa-plus px-2 fs-6"></i>Add
                </button>
            </div>

        </div>

        <div class="card-body">
            <table id="tbl" class="display nowrap" style="width:100%">
                <thead>
                    <tr>
                        <th>Sr.No </th>
                        <th>Date</th>
                        <th>Time</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        var titles = {
            bm: "Board Meeting",
            agm: "Annual General Meeting",
            eogm: "Extra Ordinary General Meeting",
            cm: "Committee Meeting"
        }

        $(document).ready(function () {
            $("#title").text(titles[`@ViewBag.type`]);
            $('[name="company_name"]').text(localStorage.getItem("comp_name"));
            loadFinancialYear()
            autocomplete()
            loadTbl()
        });

        function loadTbl() {
            $('#tbl').DataTable().destroy();
            var company = localStorage.getItem("comp_id");
            var finYear = localStorage.getItem("fin_year");
            if (!company || company === "0") return;

            d = $('#tbl').DataTable({
                ajax: {
                    url: `@R.ApiUrl/@ViewBag.ctrl/GetByCompanyAndType/${company}/@ViewBag.type/${finYear}`,
                    dataSrc: ""
                },
                columns: [
                    {
                        "targets": 0,
                        "render": function (data, type, row, meta) {
                            return meta.row + 1;
                        }
                    },
                    { data: 'dateMeeting', render: (a, b, c) => `${FORMAT_DATE(a)}` },
                    { data: 'timeMeeting' },
                    {
                        data: null,
                        render: function (a, b, c) {
                            var btn1 = `
                                <div class="btn-group">
                                    <button type="button" class="btn btn-light" onclick="edit(${a.id})">Edit</button>
                                    <button type="button" class="btn btn-light dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown" aria-expanded="false">
                                        <span class="visually-hidden">Toggle Dropdown</span>
                                    </button>
                                    <ul class="dropdown-menu">
                                        <button class="dropdown-item " onclick="del(${a.id})" style="color:red;">
                                            <i class="fa fa-trash px-2 fs-6"></i>Delete
                                        </button>
                                    </ul>
                                </div>`;
                            return btn1;
                        }, orderable: false
                    }
                ],
                order: [],
            }).on('draw.dt', function () {
                $('.dataTables_length').parent().removeClass('d-flex').removeClass('justify-content-between').addClass('d-flex').addClass('justify-content-between');
                $('input[data-toggle="toggle"]:not(\'.initialized\')').bootstrapToggle().addClass('initialized');
            });
        }

        function changeActive(id, currentStatus) {
            $.get(`@R.ApiUrl/@ViewBag.ctrl/${id}/Status/${!currentStatus}`).then(r => {
                toastr[r.status ? 'success' : 'error'](r.message);
                $('#tbl').DataTable().ajax.reload();
            });
        }

        function del(id) {
            if (!confirm('Are you sure you want to delete this?')) return;
            $.get(`@R.ApiUrl/@ViewBag.ctrl/${id}/delete`).then(r => {
                toastr[r.status ? 'success' : 'error'](r.message);
                $('#tbl').DataTable().ajax.reload();
            });
        }

        function edit(id) {
            window.location = `@Url.Action("Meeting", "Home")/Edit/${id}`;
        }

        function add() {
            var company = localStorage.getItem("comp_id");
            if (!company || company === "0") {
                alert("Select Company");
                return;
            }
            window.location = `@Url.Action("Meeting", "Home")/Add`;
        }

        function autocomplete() {
            $("#headCompSearch").autocomplete({
                source: function (request, response) {
                    $.ajax({
                        url: `@R.ApiUrl/Company/S2`,
                        dataType: "json",
                        data: { query: request.term },
                        appendTo: ".search",
                        success: function (data) {
                            response($.map(data, function (item) {
                                return {
                                    label: item.companyName,
                                    value: item.companyName,
                                    id: item.id
                                };
                            }));
                        }
                    });
                },
                select: function (event, ui) {
                    $("#headCompSearch").val("");
                    localStorage.setItem("comp_id", ui.item.id);
                    localStorage.setItem("comp_name", ui.item.label);
                    $('[name="company_name"]').text(ui.item.label);
                    $(".toggle-search:not(.nav-link)").click();
                    loadTbl();
                },
                minLength: 2
            });
        }

        function setFinYeartNloadTable() {
            localStorage.setItem("fin_year", $('#financialYear').val())
            loadTbl();
        }

        function loadFinancialYear() {
            let currentYear = new Date().getFullYear();
            let yearsList = [];
            for (let i = -1; i < 7; i++) {
                let fyStart = currentYear - i - 1;
                let fyEnd = (currentYear - i).toString().substring(2);
                let financialYear = `${fyStart}-${fyEnd}`;
                yearsList.push(`<option value="${financialYear}">${financialYear}</option>`);
            }
            $('#financialYear').append(yearsList.join(''));
            let finYear = localStorage.getItem("fin_year");
            if (finYear == undefined) {
                finYear = "none";
                localStorage.setItem("fin_year", finYear)
            }
            $('#financialYear').val(finYear);
            $('#financialYear').on('change', setFinYeartNloadTable);
        }
    </script>
}
