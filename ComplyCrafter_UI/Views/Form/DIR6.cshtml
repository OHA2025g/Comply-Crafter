@{
    ViewData["Title"] = "Particulars of " + @ViewBag.ctrl;
    ViewBag.ShowSearch = true;
}
@section HeaderBlock {
    <h4 name="company_name"></h4>
}
<div class="row m-auto">
    <div class="card">
        <div class="card-header d-flex justify-content-between mb-3">
            <h3 class="card-title mb-0 fs-4" style="margin-top:1px">
                Particulars of @ViewBag.ctrl
            </h3>
            <button class="btn btn-sm btn-outline-primary" onclick="add()"><i class="fa fa-plus px-2 fs-6"></i>Add</button>
        </div>
        <div class="card-body">
            <table id="tbl" class="display nowrap" style="width:100%">
                <thead>
                    <tr>
                        <th>Sr.No </th>
                        <th>DIN </th>
                        <th>Director Name </th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>
<div class="modal" id="myModal">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">

            <!-- Modal Header -->
            <div class="modal-header">
                <h4 class="modal-title">Select Company</h4>
                <button type="button" class="close" data-bs-dismiss="modal">&times;</button>
            </div>

            <!-- Modal body -->
            <div class="modal-body">
                <div class="col-lg-12">
                    <div class="card-body">
                        <table id="tblCompany" class="display nowrap" style="width:100%">
                            <thead>
                                <tr>
                                    <th>Sr No</th>
                                    <th>CIN Number</th>
                                    <th>Name</th>
                                    <th>Type</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


@section Scripts {
    <script>
        $(document).ready(function () {
            $('[name="company_name"]').text(localStorage.getItem("comp_name"));
            autocomplete()
            loadTbl()
        });
        
        function loadTbl() {
            $('#tbl').DataTable().destroy()
            var company = localStorage.getItem("comp_id");
            if (company === null || company === undefined || company === "0") {
                return;
            }
            d = $('#tbl').DataTable({
                ajax: {
                    url: `@R.ApiUrl/@ViewBag.ctrl/GetByCompany/${company}`,
                    dataSrc: ""
                },
                // dom: '<lBf>rtip',
                columns: [
                    {
                        "targets": 0,
                        "render": function (data, type, row, meta) {
                            return meta.row + 1;
                        }
                    },
                    {
                        data: 'directorDin',
                        render: function (data, type, row) {
                            return `<a href="#" onclick="edit(${row.id}); return false;">${data}</a>`;
                        }
                    },
                    { data: 'directorName' },
                    {
                        data: null,
                        render: function (a, b, c) {
                            var btn1 = `
                                <div class="btn-group">
                                            <button type="button" class="btn btn-light" onclick="edit(${a.id})">Edit</button>
                                            <button type="button" class="btn btn-light dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown" aria-expanded="false">
                                        <span class="visually-hidden">Toggle Dropdown</span>
                                    </button>
                                    <ul class="dropdown-menu">
                                        <button class="dropdown-item " onclick="del(${a.id})" style="color:red;"><i class="fa fa-trash px-2 fs-6"></i>Delete</button>
                                    </ul>
                                </div>`
                            return btn1

                        }, orderable: false
                    },
                    // { render: (a, b, c) => setRowContent(c), className: 'd-none rowData' }
                ],
                order: [],
            }).on('draw.dt', function () {
                $('.dataTables_length').parent().removeClass('d-flex').removeClass('justify-content-between').addClass('d-flex').addClass('justify-content-between')
                $('input[data-toggle="toggle"]:not(\'.initialized\')').bootstrapToggle().addClass('initialized');
            });
        }

        function changeActive(id, currentStatus) {
            $.get(`@R.ApiUrl/@ViewBag.ctrl/${id}/Status/${!currentStatus}`).then(r => {
                toastr[r.status ? 'success' : 'error'](r.message);
                $('#tbl').DataTable().ajax.reload()
            })
        }

        function del(id) {
            if (!confirm('Are you sure you want to delete this Form?')) return;
            $.get(`@R.ApiUrl/@ViewBag.ctrl/${id}/delete`).then(r => {
                toastr[r.status ? 'success' : 'error'](r.message);
                $('#tbl').DataTable().ajax.reload()
            })
        }

        function edit(id) {
            window.location = `@Url.Action("", "Form")/@ViewBag.ctrl/Edit/${id}`
        }

        function add() {
            var company = localStorage.getItem("comp_id");
            if (company === null || company === undefined || company === "0") {
                alert("Select Company");
                return;
            }
            window.location = `@Url.Action("", "Form")/@ViewBag.ctrl/Add`
        }

        function autocomplete() {
            $("#headCompSearch").autocomplete({
                source: function (request, response) {
                    // Send AJAX request to the API
                    $.ajax({
                        url: `@R.ApiUrl/Company/S2`,
                        dataType: "json",
                        data: {
                            query: request.term
                        },
                        appendTo: ".search",
                        success: function (data) {
                            response($.map(data, function (item) {
                                return {
                                    label: item.companyName,
                                    value: item.companyName,
                                    id: item.id
                                };
                            }));
                        }
                    });
                },
                select: function (event, ui) {
                    $("#headCompSearch").val("");
                    localStorage.setItem("comp_id", ui.item.id);
                    localStorage.setItem("comp_name", ui.item.label);
                    $('[name="company_name"]').text(ui.item.label);
                    $(".toggle-search:not(.nav-link)").click()
                    loadTbl()
                },
                minLength: 2
            });

        }

    </script>
}