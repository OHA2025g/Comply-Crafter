<style>
    .textheader a {
        color: blue;
        text-decoration: none !important;
    }

    .textheader:hover a {
        color: red !important;
        cursor: pointer;
    }

    input {
        box-shadow: 0 0 11px 1px rgba(0, 0, 0, .05) !important;
    }

</style>

<div class="row m-auto" id="frm">
    <div class="card " style="flex-direction:row;">
        <div class=" col-lg-12">
            <div class="card-header ">
                <h3>
                    MSME Form I
                </h3>

            </div>
            <div class="card-body" style="padding:0px 25px;">
                <p>
                    Form for furnishing half yearly return with the registrar in respect of outstanding payments to Micro or Small Enterprises

                    [Pursuant to Order 2 and 3 dated 22 January, 2019 issued under Section 405 of the Companies Act, 2013]
                </p>
            </div>
            <div class="textheader my-4 mx-3">
                <a href="https://www.mca.gov.in/content/dam/mca-aem-forms/instructionkits/Instruction%20Kit_MSME%20Form%20I.pdf" target="_blank">
                    Refer instruction kit for filing the form
                </a>
            </div>
        </div>
    </div>

    <div class="content-wrapper">
        <div class="container-fluid">
            <main role="main" class="pb-3">
                <div class="row">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between" style="padding: 15px 30px 10px;">
                            <ul class="nav nav-pills nav-fill p-1 bg-transparent" role="tablist">
                                <li class="nav-item">
                                    <a class="nav-link mb-0 px-4 py-1 active " href="javascript:;" role="part1" data-bs-toggle="tab">
                                        <span class="ms-1">
                                           Company Details & Declaration
                                        </span>
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <div id="part1" class="p-0">
        @*  tab-1 *@
        <input type="hidden" class="num" value="0" name="id" />
        <input type="hidden" class="num" value="0" name="companyId" />
        <div class="card" style="padding:25px;">
            <div class="tab-content">
                <br>
                <div id="Details" class="tab-pane in active animated  custon-tab-style1">
                    <div class="guideLoading guideServiceLoading dvloader" style="display: none;"></div>
                    <form action="" role="form" id="fupForm" method="post" accept-charset="utf-8" enctype="multipart/form-data">
                        <label style="font-weight: bolder; text-decoration: underline; text-transform: uppercase; margin: 0px -10px 10px;">Company Information</label>
                        <div class="row">
                            <div class="col-xs-12 col-sm-3 col-md-3 form-row bold mt-3">
                                1. (a) *Corporate Identity Number (CIN)
                            </div>
                            <div class="col-xs-12 col-sm-3 col-md-3 form-row mt-3" style="">
                                <input type="text" name="cin" id="company_cin" readonly="" value="U22219MH2022PTC375586" class="form-control">
                            </div>
                            <div class="col-xs-12 col-sm-3 col-md-3 form-row bold mt-3">
                                (b) *Name of the Company
                            </div>
                            <div class="col-xs-12 col-sm-3 col-md-3 form-row mt-3" style="">
                                <input type="text" name="companyName" id="company_name" readonly="" value="AKSHAY GRAPHICS PRIVATE LIMITED" class="form-control">
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-xs-12 col-sm-3 col-md-3 form-row bold mt-3">
                                (c) *Address of the registered office of the company
                            </div>
                            <div class="col-xs-12 col-sm-9 col-md-9 form-row mt-3">
                                <input type="text" name="companyAddress" id="company_address" readonly="" value="SHOP NO 3 VERTEX VIKAS CHS LTD   WING A SIR M V RD BHD POLICE STN ANDHERI, MUMBAI, Mumbai City, Maharashtra, India, 400069" class="form-control">
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-xs-12 col-sm-3 col-md-3 form-row bold mt-3">
                                (d) *Email ID of the company
                            </div>
                            <div class="col-xs-12 col-sm-3 col-md-3 form-row  mt-3">
                                <input type="text" name="company_Email" id="companyEmail" value="akshaygraphics69@gmail.com" readonly="" class="form-control">
                            </div>
                            <div class="col-xs-12 col-sm-3 col-md-3 form-row bold  mt-3">
                                (e) *Permanent Account Number (PAN) of the company
                            </div>
                            <div class="col-xs-12 col-sm-2 col-md-2 form-row  mt-3" style="margin-left: -10px;">
                                <input type="text" name="companyPan" id="company_pan" value="AAWCA4389D" readonly="" class="form-control">
                            </div>
                            <input type="hidden" name="pan" id="pan" value="AAWCA4389D">
                            <div class="col-xs-12 col-sm-1 col-md-1 form-row  mt-4" align="center">
                                <a id="prefillpan" class="btn btn-primary">Prefill</a>
                            </div>
                        </div>
                        <label style="font-weight: bolder; text-decoration: underline; text-transform: uppercase; margin: 0px -10px 10px;" class="mt-3">Return Details</label>
                        <div class="row">
                            <div class="col-xs-12 col-sm-3 col-md-3 form-row bold  mt-3">
                                2. (a) *Type of Return
                            </div>
                            <div class="col-xs-12 col-sm-3 col-md-3 form-row  mt-3">
                                <input type="text" name="returnType" readonly="" value="Periodic Half-yearly return" class="form-control">
                            </div>
                        </div>
                        <label style="font-weight: bolder; text-decoration: none; margin: 0px -10px 10px;">(b) *Period</label>
                        <div class="row">
                            <div class="col-xs-12 col-sm-3 col-md-3 form-row bold  mt-3">
                                Start Date (DD/MM/YYYY)
                            </div>
                            <div class="col-xs-12 col-sm-3 col-md-3 form-row  mt-3">
                                <input type="date" name="startDate" class="form-control datepicker startdate hasDatepicker" placeholder="" value="" required="" id="dp1738751967035">
                            </div>
                            <div class="col-xs-12 col-sm-3 col-md-3 form-row bold  mt-3">
                                End Date (DD/MM/YYYY)
                            </div>
                            <div class="col-xs-12 col-sm-3 col-md-3 form-row  mt-3">
                                <input type="date" name="endDate" class="form-control datepicker enddate hasDatepicker" placeholder="" value=""  required="" id="dp1738751967036">
                            </div>
                        </div>
                        <label style="font-weight: bolder; text-decoration: none; margin: 0px   -10px 10px;" class="mt-4">3 Regular half yearly return of outstanding dues (more than 45 days) to Micro or Small Enterprises Suppliers.</label><br>
                        <div class="row  mt-3">
                            <div class="col-xs-12 col-sm-12 col-md-12 mt-3" style="margin-left: -12px;color: red">
                                Note - Please report all outstanding amount that are due for more than 45 days or were liquidated after 45 days of acceptance of goods/service
                            </div>
                        </div>
                        <div class="row  mt-3">
                            <div class="col-xs-12 col-sm-8 col-md-8 bold" style="margin-left:-10px;text-transform:uppercase;">
                                Particulars of the name of (MSEs) suppliers and amount of payments due:
                            </div>
                            <div class="col-xs-12 col-sm-4 col-md-4  mt-3" align="right">
                                <a id="downloadtemplate" href="https://www.mca.gov.in/content/dam/mca_xlsx/excel-template-msme/MSME_Excel_Layout.xlsm" class="btn btn-primary">Download Template</a>

                                <label for="changesInLLPAttach" class="btn btn-primary" style="text-decoration: none;">Import from Excel</label>
                                <input type="file" name="changesInLlpAttach" id="changesInLLPAttach" style="display: none;">

                                <input type="hidden" name="hideData" id="hideendata" value="">
                            </div>
                        </div>

                        <label style="font-weight: bolder; text-decoration: underline; text-transform: uppercase; margin: 0px -10px 10px;" class="mt-4">Attachments</label>
                        <div class="row  mt-3">
                            <div class="col-xs-12 col-sm-1 col-md-1 bold form-row" align="center">
                                Sr. No
                            </div>
                            <div class="col-xs-12 col-sm-10 col-md-10 bold form-row">
                                Optional attachment(s) - if any
                            </div>
                            <div class="col-xs-12 col-sm-1 col-md-1 form-row" align="center">
                                <button type="button" name="attachmentAdd" id="attachmentadd" class="btn btn-primary" style="padding:4px 6px !important;"><i class="fa fa-plus" style="margin:0px 0px 0px 0px !important;"></i></button>
                            </div>
                        </div>

                        <div id="equity8" class=" mt-3">
                            <input type="hidden" name="l" id="l" value="1">
                            <div class="row  mt-3" id="rowq1">
                                <div class="col-xs-12 col-sm-1 col-md-1 form-row" align="center">
                                    1.
                                </div>
                                <div class="col-xs-12 col-sm-11 col-md-11 form-row">
                                    <input type="file" name="attachmentFile" id="attachmentfile_1" class="1" accept=".jpg,.pdf">
                                </div>
                            </div>
                        </div>
                        <label style="font-weight: bolder; text-decoration: underline; text-transform: uppercase; margin: 0px -10px 10px;" class="mt-4">Declaration</label>

                        <div class="row mt-3">
                            <div class="col-md-12" style="margin-left: -12px;">
                                It is hereby declared that the information given in the form and attachments are true and correct with the best of my knowledge.
                            </div>
                        </div>

                        <div class="row mt-4" style="margin-bottom: 0px;">
                            <div class="col-md-4 bold" style="margin-left: -10px;">*Designation</div>
                            <div class="col-md-4 bold">Signatory</div>
                            <div class="col-md-4 bold" style="text-align: justify;">DIN / PAN</div>
                        </div>

                        <div class="row mt-3">
                            <div class="col-md-4 mt-2">
                                <select name="declarationDesignation" id="declarationDesignation" class="form-select" required>
                                    <option value="">Select Designation</option>
                                    <option value="Director">Director</option>
                                    <option value="Managing Director">Managing Director</option>
                                    <option value="Manager">Manager</option>
                                    <option value="Company Secretory">Company Secretary</option>
                                    <option value="CFO">CFO</option>
                                    <option value="CEO">CEO</option>
                                    <option value="Authorized Representative">Authorized Representative</option>
                                </select>
                            </div>

                            <div class="col-md-4 mt-2" id="change_designation">
                                <input type="text" name="declarationMembershipNo" id="declarationMembershipNo" class="form-control" value="" required>
                            </div>

                            <div class="col-md-4 mt-2">
                                <input type="text" name="dinMemebers" id="DinMemebers" value="" class="form-control" required readonly>
                            </div>
                        </div>

                        <template id="rowTemp">
                            <div class="row mt-4" id="rowq"><div class="col-xs-12 col-sm-12 col-md-1 form-row" align="center"></div><div class="col-xs-12 col-sm-12 col-md-10 form-row"><input type="file" name="attachment_file[]" id="attachmentfile_3" class="3" accept=".jpg,.pdf"></div> <div class="col-xl-1 col-lg-1 col-md-12 col-sm-12 col-12" align="center"><button type="button" name="remove" id="3" class="btn btn-danger btn_removeeq">X</button></div></div>
                        </template>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <div class="col-m-12 mt-3">
        <button class="btn btn-md btn-primary" style="float: right;" onclick="save(event)">
            Submit
        </button>
    </div>

</div>
<script>
    let directorsList = [];

    $(document).ready(function () {
        $("#declarationDesignation").on("change", function () {
            const val = $(this).val();
            if (val === "Director" || val === "Managing Director") {
                const companyId = $("[name='companyId']").val();
                if (!companyId) return;

                $.get(`https://dev-api.complycrafter.com/api/Director/ByCompany/${companyId}`, function (data) {
                    directorsList = data || [];

                    if (directorsList.length > 0) {
                        let select = $('<select id="selectSignatory" class="form-select" required></select>');
                        select.append(`<option value="">Select Signatory</option>`);

                        directorsList.forEach((d, i) => {
                            const fullName = `${d.firstName || ""} ${d.middleName || ""} ${d.lastName || ""}`.trim();
                            select.append(`<option value="${i}">${fullName}</option>`);
                        });

                        $("#change_designation").html(select);
                    }
                });
            } else {
                // Restore input for other designations
                $("#change_designation").html('<input type="text" name="declarationMembershipNo" id="declarationMembershipNo" class="form-control" required>');
                $("#DinMemebers").val("").prop("readonly", false);
            }
        });

        $(document).on("change", "#selectSignatory", function () {
            const index = $(this).val();
            if (index !== "") {
                const dir = directorsList[index];
                $("#DinMemebers").val(dir.din || "").prop("readonly", true);
            } else {
                $("#DinMemebers").val("").prop("readonly", true);
            }
        });
    });
</script>


@section Scripts {
    <script>
        let dateOfIncorporation = null;
        let isIncorpDateLoaded = false;

        var frm = {
            id: 0,
            companyId: 0,
            cin: "",
            companyName: "",
            companyAddress: "",
            companyEmail: "",
            companyPan: "",
            returnType: "",
            startDate: "",
            endDate: "",
            attachmentFile: "",
            declarationDesignation: "",
            declarationMembershipNo: "",
            dinMemebers: "",
        };

        var voFrm = {
            id: 'required',
            companyId: 'required',
        };

        var vfFrm = null;

        $(document).ready(function () {

            $('a[data-bs-toggle="tab"]').on('shown.bs.tab', function (e) {
                var active = $(e.target).attr('role');
                $("#part1").hide();
                $("#" + active).show();
            });

            load();

            let rowCount = 1;

            $('#attachmentadd').click(function () {
                rowCount++;
                const template = $('#rowTemp').html();
                const newRow = $(template).clone();
                newRow.find('.form-row:first').text(rowCount + '.');
                $('#equity8').append(newRow);
                updateRowNumbers();
            });

            $(document).on('click', '.btn_removeeq', function () {
                $(this).closest('.row').remove();
                updateRowNumbers();
            });

            function updateRowNumbers() {
                let currentRowNumber = 1;
                $('#equity8 .row').each(function () {
                    $(this).find('.form-row:first').text(currentRowNumber + '.');
                    currentRowNumber++;
                });
                rowCount = currentRowNumber - 1;
            }

            $(".startdate").on("change", function () {
                const startVal = this.value;
                if (!isValidStartDate(startVal)) {
                    showError(this, "Start date must be either 1st April or 1st October, not before 1st Oct 2018 or date of incorporation.");
                    $(".enddate").val("");
                } else {
                    const expectedEnd = getExpectedEndDate(startVal);
                    $(".enddate").val(expectedEnd.toISOString().split("T")[0]);
                }
            });

            $(".enddate").on("change", function () {
                const startVal = $(".startdate").val();
                const endVal = this.value;
                if (!isValidEndDate(startVal, endVal)) {
                    showError(this, "End date must match period based on start date (either 30th Sept or 31st March).");
                }
            });
        });

        function save(event) {
            event.preventDefault();
            var obj = getObj(frm, '#frm');
            $._post(`@R.ApiUrl/@ViewBag.ctrl`, obj).then(x => {
                if (x.status) {
                    window.location = `@Url.Action("MSME", "Form")`;
                } else {
                    swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: x.message
                    });
                }
            });
        }

        function load() {
            if (@ViewBag.id > 0) {
                $._get(`@R.ApiUrl/@ViewBag.ctrl/${@ViewBag.id}`).then(x => {
                    frm = x;
                    setObj(x, "#frm");
                });
            }
            var company = localStorage.getItem("comp_id");
            if (company === null || company === undefined || company === "0") {
                alert("Please select Company");
                window.location = `@Url.Action("MSME", "Form")`;
                return;
            }
            $._get(`@R.ApiUrl/Company/${company}`).then(x => {
                $("[name='companyId']").val(x.id);
                $("[name='cin']").val(x.cin);
                $("[name='companyName']").val(x.companyName);
                $("[name='companyAddress']").val(x.address);
                $("[name='companyEmail']").val(x.email);
                dateOfIncorporation = new Date(x.incorporationDate);
                isIncorpDateLoaded = true;
            });
        }

        const MIN_DATE = new Date("2018-10-01");

        function isValidStartDate(dateStr) {
            const d = new Date(dateStr);
            const day = d.getDate();
            const month = d.getMonth();
            return (day === 1 && (month === 3 || month === 9)) && d >= MIN_DATE && (!dateOfIncorporation || d >= dateOfIncorporation);
        }

        function getExpectedEndDate(startDateStr) {
            const d = new Date(startDateStr);
            const year = d.getFullYear();
            const month = d.getMonth();
            if (month === 3) return new Date(`${year}-09-30`);
            if (month === 9) return new Date(`${year + 1}-03-31`);
            return null;
        }

        function isValidEndDate(startStr, endStr) {
            const expected = getExpectedEndDate(startStr);
            const end = new Date(endStr);
            return expected && expected.getTime() === end.getTime();
        }

        function showError(field, message) {
            alert(message);
            field.value = "";
            field.focus();
        }
    </script>
}
